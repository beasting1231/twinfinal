rules_version = '2';
// Updated: 2025-11-05 - Added role-based access control
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user's role
    function getUserRole() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user has a role
    function hasRole(role) {
      return request.auth != null && getUserRole() == role;
    }

    // Helper function to check if user has any of the roles
    function hasAnyRole(roles) {
      return request.auth != null && getUserRole() in roles;
    }

    // Helper function to get user's display name
    function getUserDisplayName() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.displayName;
    }

    // Helper function to check if pilot is only removing themselves from assignedPilots
    function isPilotSelfUnassign() {
      let userDisplayName = getUserDisplayName();
      let oldPilots = resource.data.assignedPilots;
      let newPilots = request.resource.data.assignedPilots;

      // Check that only assignedPilots field is being changed
      let onlyPilotsChanged = request.resource.data.diff(resource.data).affectedKeys().hasOnly(['assignedPilots']);

      // Check that the user's name was in the old array
      let wasAssigned = userDisplayName in oldPilots;

      // Check that the arrays are same length
      let sameLengthArrays = oldPilots.size() == newPilots.size();

      return onlyPilotsChanged && wasAssigned && sameLengthArrays;
    }

    // Helper function to check if pilot is updating payment info on a booking they're assigned to
    function isPilotUpdatingOwnPayment() {
      let userDisplayName = getUserDisplayName();
      let assignedPilots = resource.data.assignedPilots;

      // Check that the pilot is assigned to this booking
      let isAssigned = userDisplayName in assignedPilots;

      // Check that only pilotPayments and history fields are being changed
      // (history is added automatically with every update for audit trail)
      let onlyPaymentsChanged = request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pilotPayments', 'history']);

      return isAssigned && onlyPaymentsChanged;
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Allow public read for booking form availability check
      allow read: if true;

      // Pilot: can create bookings
      // Agency: can create bookings
      // Driver: can create bookings
      // Admin: can create bookings
      allow create: if request.auth != null && hasAnyRole(['pilot', 'agency', 'driver', 'admin']);

      // Pilot: can update only their own bookings (check createdBy)
      //        OR can update any booking to remove themselves from assignedPilots
      //        OR can update pilotPayments on bookings they're assigned to
      // Agency: can update only their own bookings (check createdBy)
      // Driver: can update all bookings
      // Admin: can update all bookings
      // Note: Allow updates to bookings without createdBy field (legacy bookings)
      allow update: if request.auth != null && (
        hasAnyRole(['driver', 'admin']) ||
        (hasRole('pilot') && isPilotSelfUnassign()) ||
        (hasRole('pilot') && isPilotUpdatingOwnPayment()) ||
        (hasAnyRole(['pilot', 'agency']) && (
          !('createdBy' in resource.data) ||
          resource.data.createdBy == request.auth.uid
        ))
      );
      allow delete: if request.auth != null && (
        (hasAnyRole(['pilot', 'agency', 'driver']) && resource.data.createdBy == request.auth.uid) ||
        hasRole('admin')
      );
    }

    // Booking requests collection
    match /bookingRequests/{requestId} {
      // Anyone can create a booking request (public form)
      allow create: if true;
      // Only admin can read/update/delete
      allow read, update, delete: if request.auth != null && hasRole('admin');
    }

    // Gift vouchers collection
    match /giftVouchers/{voucherId} {
      // Anyone can create a gift voucher order (public form)
      allow create: if true;
      // Only admin can read/update/delete
      allow read, update, delete: if request.auth != null && hasRole('admin');
    }

    // Availability collection
    match /availability/{availabilityId} {
      // Allow public read for booking form availability check
      allow read: if true;

      // Pilot: can create/update/delete only their own availability
      // Driver: can create/update/delete anyone's availability
      // Admin: can create/update/delete anyone's availability
      allow create: if request.auth != null && (
        (hasRole('pilot') && request.resource.data.userId == request.auth.uid) ||
        hasAnyRole(['driver', 'admin'])
      );
      allow update, delete: if request.auth != null && (
        (hasRole('pilot') && resource.data.userId == request.auth.uid) ||
        hasAnyRole(['driver', 'admin'])
      );
    }

    // Booking sources collection
    match /bookingSources/{sourceId} {
      // All authenticated users can read (needed to display booking source colors)
      allow read: if request.auth != null;
      // Only driver and admin can write
      allow write: if request.auth != null && hasAnyRole(['driver', 'admin']);
    }

    // Driver assignments collection
    match /driverAssignments/{assignmentId} {
      // Pilots can read (view driver assignments)
      // Driver and admin can read/write
      allow read: if request.auth != null && hasAnyRole(['pilot', 'driver', 'admin']);
      allow write: if request.auth != null && hasAnyRole(['driver', 'admin']);
    }

    // User profiles collection
    match /userProfiles/{profileId} {
      // Allow public read for booking form availability check
      allow read: if true;

      // Users can create their own profile (default role will be null)
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;

      // Users can update their own profile (except role field)
      // Admins can update anyone's profile including role
      allow update: if request.auth != null && (
        (resource.data.uid == request.auth.uid && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        hasRole('admin')
      );
    }

    // Driver locations collection
    match /driverLocations/{locationId} {
      // Drivers can read all locations (to see other drivers)
      // Admin can read all locations
      allow read: if request.auth != null && hasAnyRole(['driver', 'admin']);

      // Drivers can create/update only their own location (document ID must match user ID)
      allow create, update: if request.auth != null &&
        hasRole('driver') &&
        locationId == request.auth.uid;

      // Admin can delete any location
      allow delete: if request.auth != null && hasRole('admin');
    }

    // Pilot orders collection (custom daily pilot ordering)
    match /pilotOrders/{dateId} {
      // All authenticated users can read (to see pilot order)
      allow read: if request.auth != null;

      // Only admins can create, update, or delete pilot orders
      allow create, update, delete: if request.auth != null && hasRole('admin');
    }

    // Settings collection (notification settings, etc.)
    match /settings/{settingId} {
      // Form settings are publicly readable (for booking form)
      allow read: if settingId == 'form';
      // Other settings require admin auth to read
      allow read: if settingId != 'form' && request.auth != null && hasRole('admin');
      // Only admins can write any settings
      allow write: if request.auth != null && hasRole('admin');
    }

    // Email queue collection (for sending emails via Cloud Functions)
    match /emailQueue/{emailId} {
      // Authenticated users can create email requests
      allow create: if request.auth != null;
      // Only the Cloud Function (admin SDK) can read/update/delete
      allow read, update, delete: if false;
    }

    // Time overrides collection (for changing displayed time slots)
    match /timeOverrides/{dateId} {
      // All authenticated users can read (to see changed times)
      allow read: if request.auth != null;
      // Only admins can create, update, or delete time overrides
      allow create, update, delete: if request.auth != null && hasRole('admin');
    }

    // Booking forms collection (custom booking forms with commission rates)
    match /bookingForms/{formId} {
      // Public read (for booking request form to get form settings)
      allow read: if true;
      // Only admins can create, update, or delete booking forms
      allow create, update, delete: if request.auth != null && hasRole('admin');
    }
  }
}
